# SMART CONTRACT AUTOMATED TESTING GUIDELINES

## Forewords

The documents aim to recap my experience in smart contract automated testing besides the manual testing. I also put the issues that I faced during the execution, indeed, solutions are given.

## Connect with Remix from Local

For a complex project, you can't just copy paste the single sol file and let it run. To make our life easier, Remix has localhost connection which allows you to interact with your project in your local machine remotely.

This is something I'm used to doing when the project has a large number of inheritant contracts. Obviously, this make our life easier than ever by just downloading the git project and do some commands.

### Steps:

1. Compile your truffle contract if needed with `npm install` (!remember remvove the package-lock.json, if it does have it). Otherwise, the remix wouldn't be able to load all libraries for the contracts that are being called.

2. Go to WorkSpaces on the left panel and choose "Connect to Localhost"

![Connect to localhost](https://github.com/enderphan94/solidity-pentest/blob/master/images/remix1.png?raw=true)

3. The message box pops up and you just need to read carefully and copy the command shown in the box to connect your localhost

![Get the command line](https://github.com/enderphan94/solidity-pentest/blob/master/images/remix2.png?raw=true){ width=50% }

```bash
remixd -s path-to-the-shared-folder --remix-ide remix-ide-instance-URL
```

Important:

> path-to-the-shared-folder: needs to be an absolute path

> remix-ide-instance-URL: needs to plain with http or https

eg: 

```bash
remixd -s /home/enderphan/LOLToken/ --remix-ide http(s)://your-remix-address.com/
```

### Issues

#### Issue 1

Somtimes I still got this error from Remix

>Cannot connect to the remixd daemon. 
>Please make sure you have the remixd running in the background.

What I just do is switch to another terminal and re-type the remixd command. If needed, you can just uinstall and reinstall the remixd (Close VS-Code to do this, if you have it opened)

https://remix-ide.readthedocs.io/en/latest/remixd.html

#### Issue 2

The same error but another issue.

https://ethereum.stackexchange.com/questions/78637/cant-connect-remix-ide-using-remixd

## Solc version problems

Source: https://github.com/crytic/solc-select

### Issues

You need to just switch the version of solc quickly by a command. The version of solc is kindda painful, depending on the tools and project, you need to use a specific and exact version to compile.. otherwise broke.

During my audit, I've suffered with solc-select installations. I used to install  via the shell command, but now they've upraded to pip3. The thing is that some docker containers do not support pip3, so you would need to install solc-selct into that docker but pip3. Therefore, I'v a copied version of the solc-select installed via shell.

### Installation

Via shell: https://github.com/enderphan94/solc-select-sh-version

Via Pip3: https://github.com/crytic/solc-select

### Usage:

Install the version you want

```bash
solc-select install 0.8.0
```

And use it
```bash
solc-select use 0.8.0
```

Check your solc version again

```bash
solc --version
```
## Tools

### 1. Slither

Source: https://github.com/crytic/slither

#### Features

* Detects vulnerable Solidity code with low false positives (see the list of [trophies](./trophies.md))
* Identifies where the error condition occurs in the source code
* Easily integrates into continuous integration and Truffle builds
* Built-in 'printers' quickly report crucial contract information
* Detector API to write custom analyses in Python
* Ability to analyze contracts written with Solidity >= 0.4
* Intermediate representation ([SlithIR](https://github.com/trailofbits/slither/wiki/SlithIR)) enables simple, high-precision analyses
* Correctly parses 99.9% of all public Solidity code
* Average execution time of less than 1 second per contract

#### How to install

Slither requires Python 3.6+ and [solc](https://github.com/ethereum/solidity/), the Solidity compiler.

##### Using Pip

```bash
pip3 install slither-analyzer
```

##### Using Git

```bash
git clone https://github.com/crytic/slither.git && cd slither
python3 setup.py install
```

We recommend using an Python virtual environment, as detailed in the [Developer Installation Instructions](https://github.com/trailofbits/slither/wiki/Developer-installation), if you prefer to install Slither via git.

##### Using Docker

Use the [`eth-security-toolbox`](https://github.com/trailofbits/eth-security-toolbox/) docker image. It includes all of our security tools and every major version of Solidity in a single image. `/home/share` will be mounted to `/share`  in the container.

```bash
docker pull trailofbits/eth-security-toolbox
```

To share a directory in the container:

```bash
docker run -it -v /home/share:/share trailofbits/eth-security-toolbox
```

#### Usage

```slither <file-name>.sol```

### 2. Mythril

Mythril detects a range of security issues, including integer underflows, owner-overwrite-to-Ether-withdrawal, and others. Note that Mythril is targeted at finding common vulnerabilities, and is not able to discover issues in the business logic of an application. Furthermore, Mythril and symbolic executors are generally unsound, as they are often unable to explore all possible states of a program.

Source: https://github.com/ConsenSys/mythril

#### How to install

```bash
$ docker pull mythril/myth
```

Install from Pypi:

```bash
$ pip3 install mythril
```

Note: In my exprience, I prefer using mythril version installed via pip3 rather than Docker. I've faced so many issues with the docker version, and I decided to switch to pip3 one.

#### Usage

Via pip3: https://github.com/ConsenSys/mythril/blob/develop/README.md#usage

Via Docker: ```docker run -v $(pwd):/tmp mythril/myth a /tmp/<file-name>.sol --solv 0.5.0```

#### Issues

##### Issue 1
In case the tool gives you this error:

> mythril.mythril.mythril_disassembler [ERROR]: The file Token.sol does not contain a compilable contract.
> mythril.interfaces.cli [ERROR]: input files do not contain any valid contracts

We can use contract address in testnet or ganache
https://mythril-classic.readthedocs.io/en/master/security-analysis.html

Ganache: ```myth a --rpc ganache -a <address>```

##### Issue 2

Evn: MacOS

Just in case the command ```Pip3 install mythril``` does not work. I don't remember what happened exactly but something does not work with pip3 in MacOS :)

Use the following command 

```bash
sudo xcode-select --switch /Library/Developer/CommandLineTools
```

##### Issue 3

Error

>in self.solidity_files[file_index].full_contract_src_maps
>IndexError: list index out of range

Just uninstall mythril and reinstall it

```bash
pip3 uninstall mythril
```

```bash
pip3 install mythril
````

### Manticore

This tool takes quite a long time to complete.

#### Features

Program Exploration: Manticore can execute a program with symbolic inputs and explore all the possible states it can reach

Input Generation: Manticore can automatically produce concrete inputs that result in a given program state

Error Discovery: Manticore can detect crashes and other failure cases in binaries and smart contracts

Instrumentation: Manticore provides fine-grained control of state exploration via event callbacks and instruction hooks

Programmatic Interface: Manticore exposes programmatic access to its analysis engine via a Python API

#### Installation

> Note: We recommend installing Manticore in a [virtual environment](https://packaging.python.org/guides/installing-using-pip-and-virtual-environments/#installing-virtualenv)
 to prevent conflicts with other projects or packages

Option 1: Installing from PyPI:

```bash
pip install manticore
```

Option 2: Installing from PyPI, with extra dependencies needed to execute native binaries:

```bash
pip install "manticore[native]"
```

Option 3: Installing a nightly development build:

```bash
pip install --pre "manticore[native]"
```

Option 4: Installing from the `master` branch:

```bash
git clone https://github.com/trailofbits/manticore.git
cd manticore
pip install -e ".[native]"
```

Option 5: Install via Docker:

```bash
docker pull trailofbits/manticore
```

Once installed, the `manticore` CLI tool and Python API will be available.

For a development installation, see our [wiki](https://github.com/trailofbits/manticore/wiki/Hacking-on-Manticore).

#### Usage

Sigle contract in a file

```bash
manticore <file-name>.sol
```

Mutiple contracts in a file

```bash
manticore <file-name>.sol --contract <main-contract-name>
```

Note:

Manticore takes quite a long time to complete the scan by default, so usually I also use `--quick-mode` option for quick exploration. Disable gas, generate testcase only for alive states, do not explore constant functions. Disable all detectors.

```bash
manticore <file-name>.sol --contract <main-contract-name> --quick-mode
```


